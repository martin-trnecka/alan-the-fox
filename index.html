<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Lišák Alan | Katedra Informatiky, Univerzita Palackeho v Olomouci</title>

  <link rel="stylesheet" href="./css/alan.css">

  <!-- knihovna Blocky -->
  <script src="./blocky/blockly.js"></script>
  <script src="./blocky/javascript.js"></script>
  <script src="./blocky/alan_blocks.js"></script>
  <script src="./blocky/alan_generators.js"></script>

  <!-- levely -->
  <script src="./levels/level.js"></script>

  <meta name="author" content="Martin Trnecka, Marketa Trneckova">
</head>

<body>

  <main>
      <div class="level-details">
          <a href="#" class="level" id="level-id">1</a>
          <p id="popis-levelu">Popis levelu, co se má dělat a ja k se to má dělat.</p>
      </div>

      <div class="mapa">
        <canvas id="deska" width="1000" height="700"></canvas>
      </div>

      <div class="levels">
        <a href="#1" onclick="hra.nacti_level(1);" class="level">1</a>
        <a href="#2" onclick="hra.nacti_level(2);" class="level">2</a>
        <a href="#3" onclick="hra.nacti_level(3);" class="level">3</a>
        <a href="#4" onclick="hra.nacti_level(4);" class="level">4</a>
        <a href="#5" onclick="hra.nacti_level(5);" class="level">5</a>
        <a href="#6" onclick="hra.nacti_level(6);" class="level">6</a>
        <a href="#7" onclick="hra.nacti_level(7);" class="level">7</a>
        <a href="#8" onclick="hra.nacti_level(8);" class="level">8</a>
        <a href="#9" onclick="hra.nacti_level(9);" class="level">9</a>
        <a href="#10" onclick="hra.nacti_level(10);" class="level">10</a>
        <a href="#11" onclick="hra.nacti_level(11);" class="level">11</a>
        <a href="#12" onclick="hra.nacti_level(12);" class="level">12</a>
        <a href="#13" onclick="hra.nacti_level(13);" class="level">13</a>
        <a href="#14" onclick="hra.nacti_level(14);" class="level">14</a>
        <a href="#15" onclick="hra.nacti_level(15);" class="level">15</a>
        <a href="#16" onclick="hra.nacti_level(16);" class="level">16</a>
        <a href="#17" onclick="hra.nacti_level(17);" class="level">17</a>
        <a href="#18" onclick="hra.nacti_level(18);" class="level">18</a>
        <a href="#19" onclick="hra.nacti_level(19);" class="level">19</a>
      </div>

      <div class="editor">
        <div class="tabs">

          <div id="blockly" style="position: absolute"></div>

          <textarea id="textarea" style="height: 650px; width: 600px;" class="hidden"></textarea>
        </div>
      </div>

      <div class="controls">
        <a href="#" onclick="run();" id="start">spustit</a>
        <!-- <a href="#" onclick="reset();">zkusit znovu</a> -->
        <a href="#" onclick="stop();" id="stop">zastavit</a>
      </div>
  </main>

  <xml id="startblock" style="display: none">
    <block type="start"></block>
  </xml>

<small class="credit">&copy; Lišák Alan 1.0 | Martin Trnečka a Markéta Trnečková | <a href="https://www.inf.upol.cz/">Katedra informatiky</a> | <a href="https://www.upol.cz/">Univerzita Palackého v Olomouci</a>

<span>založeno na <a href="https://developers.google.com/blockly" rel="external"><img src="./assets/blockly.svg"></a></span>
</small>

      <!-- assets -->
      <img id="grass1" src="./assets/grass1.svg" class="hidden">       <!-- 1 -->
      <img id="grass2" src="./assets/grass2.svg" class="hidden">       <!-- 2 -->
      <img id="grass3" src="./assets/grass3.svg" class="hidden">       <!-- 3 -->
      <img id="hill1" src="./assets/hill1.svg" class="hidden">         <!-- 4 -->
      <img id="hill2" src="./assets/hill2.svg" class="hidden">         <!-- 5 -->
      <img id="grass4" src="./assets/grass4.svg" class="hidden">       <!-- 6 -->
      <img id="grass5" src="./assets/grass5.svg" class="hidden">       <!-- 7 -->
      <img id="fox1" src="./assets/fox4.svg" class="hidden">           <!-- 201, na kytce 211, 221, 231 -->
      <img id="fox2" src="./assets/fox2.svg" class="hidden">           <!-- 202, na kytce 212, 222, 232 -->
      <img id="fox3" src="./assets/fox1.svg" class="hidden">           <!-- 203, na kytce 213, 223, 233 -->
      <img id="fox4" src="./assets/fox3.svg" class="hidden">           <!-- 204, na kytce 214, 224, 234 -->
      <img id="chicken1" src="./assets/chicken1.svg" class="hidden">   <!-- 301 -->
      <img id="chicken2" src="./assets/chicken2.svg" class="hidden">   <!-- 302 -->
      <img id="tree1" src="./assets/tree1.svg" class="hidden">         <!-- 11 -->
      <img id="tree2" src="./assets/tree2.svg" class="hidden">         <!-- 12 -->
      <img id="tree3" src="./assets/tree3.svg" class="hidden">         <!-- 13 -->
      <img id="tree4" src="./assets/tree4.svg" class="hidden">         <!-- 14 -->
      <img id="water1" src="./assets/water1.svg" class="hidden">       <!-- 31 -->
      <img id="water2" src="./assets/water2.svg" class="hidden">       <!-- 32 -->
      <img id="water3" src="./assets/water3.svg" class="hidden">       <!-- 33 -->
      <img id="water4" src="./assets/water4.svg" class="hidden">       <!-- 34 -->
      <img id="water5" src="./assets/water5.svg" class="hidden">       <!-- 35 -->
      <img id="water6" src="./assets/water6.svg" class="hidden">       <!-- 36 -->
      <img id="water7" src="./assets/water7.svg" class="hidden">       <!-- 37 -->
      <img id="doghouse" src="./assets/dog-house.svg" class="hidden">  <!-- 41 -->
      <img id="barn" src="./assets/barn.svg" class="hidden">           <!-- 42 -->
      <img id="carrot" src="./assets/carrot.svg" class="hidden">       <!-- 43 -->
      <img id="fence1" src="./assets/fence1.svg" class="hidden">       <!-- 51 -->
      <img id="fence2" src="./assets/fence2.svg" class="hidden">       <!-- 52 -->
      <img id="fence3" src="./assets/fence3.svg" class="hidden">       <!-- 53 -->
      <img id="dog1" src="./assets/dog3.svg" class="hidden">           <!-- 401 -->
      <img id="dog2" src="./assets/dog1.svg" class="hidden">           <!-- 402 -->
      <img id="dog3" src="./assets/dog4.svg" class="hidden">           <!-- 403 -->
      <img id="dog4" src="./assets/dog2.svg" class="hidden">           <!-- 404 -->
      <img id="flower1" src="./assets/flower1.svg" class="hidden">     <!-- 501 -->
      <img id="flower2" src="./assets/flower2.svg" class="hidden">     <!-- 502 -->
      <img id="flower3" src="./assets/flower3.svg" class="hidden">     <!-- 503 -->




  <script>
  // výchozí toolbox
  var toolbox = '<xml>' +
      '<block type="krok"></block>' +
      '<block type="seber_slepici"></block>' +
      //'<block type="otoc_vlevo"></block>' +
      //'<block type="otoc_vpravo"></block>' +
      //'<block type="opakuj"></block>' +
      //'<block type="opakuj_p"></block>' +
      //'<block type="if_p"></block>' +
      //'<block type="function_1"></block>' +
      //'<block type="call_f1"></block>' +
    '</xml>';

  // Alan the fox
  var hra = {

    // inicializace
    deska: [],
    deska_original: [],
    pohyb_pes: [],
    index_pohyb_pes: 0,
    stop: 0,

    // nacti sandbox (vychozi jednoducha hra)
    nacti_sandbox: function(level) {
      // level pri chybe

      this.deska = [[ 31, 31, 31, 31,  31,  31,  31,  31, 31, 31],
              [ 31, 31, 31, 31,  31,  31, 31, 31, 31, 31],
              [ 31, 31, 31, 31,  31,  31, 31, 31, 31, 31],
              [ 31, 31, 31, 31,  31,  31, 31, 31, 31, 31],
              [ 31, 31, 31, 201,  1,  301, 31, 31, 31, 31],
              [ 31, 31, 31, 31,  31,  31, 31, 31, 31, 31],
              [ 31, 31, 31, 31,  31,  31, 31, 31, 31, 31],
              [ 31, 31, 31, 31,  31,  31, 31, 31, 31, 31],
              [ 31, 31, 31, 31,  31,  31, 31, 31, 31, 31],
              [ 31, 31, 31, 31,  31,  31, 31, 31, 31, 31]];

      this.deska_original = [[ 31, 31, 31, 31,  31,  31,  31,  31, 31, 31],
              [ 31, 31, 31, 31,  31,  31, 31, 31, 31, 31],
              [ 31, 31, 31, 31,  31,  31, 31, 31, 31, 31],
              [ 31, 31, 31, 31,  31,  31, 31, 31, 31, 31],
              [ 31, 31, 31, 1,  1,  301, 31, 31, 31, 31],
              [ 31, 31, 31, 31,  31,  31, 31, 31, 31, 31],
              [ 31, 31, 31, 31,  31,  31, 31, 31, 31, 31],
              [ 31, 31, 31, 31,  31,  31, 31, 31, 31, 31],
              [ 31, 31, 31, 31,  31,  31, 31, 31, 31, 31],
              [ 31, 31, 31, 31,  31,  31, 31, 31, 31, 31]],

      document.getElementById('level-id').innerHTML = level;
      document.getElementById('popis-levelu').innerHTML = "Je nám líto, ale level " + level + " neexistuje. Zkuste jiný level z nabídky níže.";
    },

    // nacitani jednotlivých levelů
    nacti_level: function(level) {
      this.level = level;
      if(level>=levels.length) {
        this.nacti_sandbox(level);
        this.nakresli_mapu();
        return;
      }
      // TODO: stringify je pomalé, bylo by lepší udělat DeepCopy jinak
      this.deska = JSON.parse(JSON.stringify(levels[level].mapa));
      this.deska_original = JSON.parse(JSON.stringify(levels[level].mapa));

      // pozice Alana
      this.deska[levels[level].pozice_lisky[0]][levels[level].pozice_lisky[1]] = 200 + levels[level].pozice_lisky[2];

      // pozice psa
      this.pohyb_pes = levels[level].instrukce_psa;

      if (this.pohyb_pes.length != 0) {
        this.deska[levels[level].instrukce_psa[0][0]][levels[level].instrukce_psa[0][1]] = 400 + levels[level].instrukce_psa[0][2];
      }

      this.index_pohyb_pes = 0;

      if (this.pohyb_pes.length > 1) {
          this.index_pohyb_pes = 1;
      }


      // zmeny v UI
      document.getElementById('level-id').innerHTML = level;
      document.getElementById('popis-levelu').innerHTML = levels[level].popis;

      // dostupné instrukce
      this.instrukcni_sada = this.update_available_instructions(levels[level].instrukcni_sada);

      this.init();
      this.nakresli_mapu();
    },

    reset: function() {
      this.deska = JSON.parse(JSON.stringify(levels[this.level].mapa));
      this.deska_original = JSON.parse(JSON.stringify(levels[this.level].mapa));

      // pozice Alana
      this.deska[levels[this.level].pozice_lisky[0]][levels[this.level].pozice_lisky[1]] = 200 + levels[this.level].pozice_lisky[2];

      // pozice psa
      this.pohyb_pes = levels[this.level].instrukce_psa;

      if (this.pohyb_pes.length != 0) {
        this.deska[levels[this.level].instrukce_psa[0][0]][levels[this.level].instrukce_psa[0][1]] = 400 + levels[this.level].instrukce_psa[0][2];
      }

      this.index_pohyb_pes = 0;

      if (this.pohyb_pes.length > 1) {
          this.index_pohyb_pes = 1;
      }

      this.nakresli_mapu();
    },

    init: function() {
      if(this.workspace) {
        this.workspace.dispose();
      }
      this.workspace = Blockly.inject('blockly', {toolbox: this.instrukcni_sada, toolboxPosition: "start",  zoom:
               {startScale: 0.8}, trashcan: "true", maxInstances: this.instrukcni_sada});
      //this.workspace.updateToolbox(this.instrukcni_sada);
      Blockly.Xml.domToWorkspace(document.getElementById('startblock'), this.workspace);
    },

    update_available_instructions: function(instrukcni_sada) {
      var toolbox =  '<xml>';
        for (let [key, value] of Object.entries(instrukcni_sada)) {
        toolbox += '<block type="'+key+'"></block>';
      }
      toolbox += '</xml>';

      return toolbox
    },

    krok: function() {
      console.log('krok vpřed');

      this.posun_psa();

      var zakazane = [0, 4, 5, 11, 12, 13, 14, 31, 32, 33, 34, 35, 36, 37, 41, 42, 43, 51, 52, 53, 401, 402, 403, 404]; // seznam zakazanych policek

      // TODO: výjimky
      var [x, y] = this.najdi_alana();
      if(this.deska[x][y]==201 || this.deska[x][y]==211 || this.deska[x][y]==221 || this.deska[x][y]==231) {
        new_x = x;
        new_y = y+1;
      }
      if(this.deska[x][y]==202 || this.deska[x][y]==212 || this.deska[x][y]==222 || this.deska[x][y]==232) {
        new_x = x+1;
        new_y = y;
      }
      if(this.deska[x][y]==203 || this.deska[x][y]==213 || this.deska[x][y]==223 || this.deska[x][y]==233) {
        new_x = x;
        new_y = y-1;
      }
      if(this.deska[x][y]==204 || this.deska[x][y]==214 || this.deska[x][y]==224 || this.deska[x][y]==234) {
        new_x = x-1;
        new_y = y;
      }

      if(new_x < 0 || new_x>9 || new_y <0 || new_y >9) {
        throw "lisak pres palubu";
      }

      if(zakazane.includes(this.deska[new_x][new_y])) {
        throw "zakazane";
      }

      if(this.deska[x][y] > 210 && this.deska[x][y] < 215)   //odstraneni podminky u lisky
        this.deska[x][y] -=10;

      if(this.deska[x][y] > 220 && this.deska[x][y] < 225)
        this.deska[x][y] -=20;

      if(this.deska[x][y] > 230 && this.deska[x][y] < 235)
        this.deska[x][y] -=30;

      this.deska[new_x][new_y]=this.deska[x][y];

      if(this.deska_original[new_x][new_y]==501)            //podminka
        this.deska[new_x][new_y] += 10;

      if(this.deska_original[new_x][new_y]==502)            //podminka
        this.deska[new_x][new_y] += 20;

      if(this.deska_original[new_x][new_y]==503)            //podminka
        this.deska[new_x][new_y] += 30;

      //console.log(JSON.stringify(this.deska));
      this.deska[x][y] = this.deska_original[x][y] ;
    },

    seber_slepici: function() {
      console.log('seber slepici');
      var [x, y] = this.najdi_alana();

      if (this.deska_original[x][y]>300 && this.deska_original[x][y]<305) {
        this.deska_original[x][y] = 1;
      }
      var pocet = this.pocet_slepic();
      if(pocet == 0) {
        throw "konec";
      }
    },

    otoc_vpravo: function() {
      console.log('otoc vpravo');
      this.posun_psa();
      var [x, y] = this.najdi_alana();
      this.deska[x][y] = this.deska[x][y] + 1;
      if(this.deska[x][y]==205) this.deska[x][y] = 201;
    },

    otoc_vlevo: function() {
      console.log('otoc vlevo');
      this.posun_psa();
      var [x, y] = this.najdi_alana();
      this.deska[x][y] = this.deska[x][y] - 1;
      if(this.deska[x][y]==200) this.deska[x][y] = 204;
    },

    podminka_P1: function() {
      console.log('over podminku');
      var [x, y] = this.najdi_alana();
      if(this.deska[x][y]>210 && this.deska[x][y]<215)
      {
        return false;
      }
      return true;
    },

    podminka_P2: function() {
      console.log('over podminku');
      var [x, y] = this.najdi_alana();
      if(this.deska[x][y]>220 && this.deska[x][y]<225)
      {
        return false;
      }
      return true;
    },

    podminka_P3: function() {
      console.log('over podminku');
      var [x, y] = this.najdi_alana();
      if(this.deska[x][y]>230 && this.deska[x][y]<235)
      {
        return false;
      }
      return true;
    },

    // najde lišku
    najdi_alana: function() {
      for (var x = 0; x < 10; x++) {
        for (var y = 0; y < 10; y++) {
          if (this.deska[x][y]>200 && this.deska[x][y]<300) {
            return [x,y];
          }
        }
      }
    },

    smer_alana: function() {
      var [x, y] = this.najdi_alana();
      return this.deska[x][y]-200;
    },

    // najde psa
    najdi_psa: function() {
      for (var x = 0; x < 10; x++) {
        for (var y = 0; y < 10; y++) {
          if (this.deska[x][y]>400 && this.deska[x][y]<420) {
            return [x, y];
          }
        }
      }
    },

    posun_psa: function() {
      if(this.pohyb_pes.length > 0) {
        var [x, y] = this.najdi_psa();
        this.deska[x][y] = this.deska_original[x][y];
        this.deska[this.pohyb_pes[this.index_pohyb_pes][0]][this.pohyb_pes[this.index_pohyb_pes][1]]=400+this.pohyb_pes[this.index_pohyb_pes][2];
        this.index_pohyb_pes +=1;
        if(this.index_pohyb_pes >= this.pohyb_pes.length) {
          this.index_pohyb_pes =0;
        }
      }
    },

    // pocet slepic
    pocet_slepic: function() {
      var pocet = 0;
      for (var x = 0; x < 10; x++) {
        for (var y = 0; y < 10; y++) {
          if (this.deska_original[x][y]>300 && this.deska_original[x][y]<310) {
            pocet += 1;
          }
        }
      }
      return pocet;
    },

    nakresli_mapu: function() {
      console.log('map rendering...');
      var elem = document.getElementById('deska');
      var context = elem.getContext('2d');
      var zarovnani_x = 450;
      var zarovnani_y = 60;

      context.clearRect(0, 0, elem.width, elem.height);

      var scale = 0.8;
      tile1 = document.getElementById("grass1");
      var move_x = tile1.width*scale;
      var move_y = tile1.height*scale - 5*scale;


      for (var x = 0; x < 10; x++) {
        for (var y = 0; y < 10; y++) {
          // prázdné políčko
          if (this.deska[x][y] == 1 || this.deska[x][y] > 200) {
              tile = document.getElementById("grass1");
              if (this.deska[x][y]) context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y, tile.width*scale, tile.height*scale);
          }

          // trava2
          if (this.deska[x][y] == 2) {
              tile = document.getElementById("grass2");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // trava2
          if (this.deska[x][y] == 3) {
              tile = document.getElementById("grass3");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // hill1
          if (this.deska[x][y] == 4) {
              tile = document.getElementById("hill1");
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x+ 1*scale, x*move_y/2 + y*move_y/2+zarovnani_y-24*scale, tile.width*scale, tile.height*scale);
          }

          // hill2
          if (this.deska[x][y] == 5) {
              tile = document.getElementById("hill2");
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x+ 1*scale, x*move_y/2 + y*move_y/2+zarovnani_y-24*scale, tile.width*scale, tile.height*scale);
          }

          // trava4
          if (this.deska[x][y] == 6) {
              tile = document.getElementById("grass4");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // trava5
          if (this.deska[x][y] == 7) {
              tile = document.getElementById("grass5");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // strom1
          if (this.deska[x][y] == 11) {
              tile = document.getElementById("tree1");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // strom2
          if (this.deska[x][y] == 12) {
              tile = document.getElementById("tree2");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // strom3
          if (this.deska[x][y] == 13) {
              tile = document.getElementById("tree3");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // strom4
          if (this.deska[x][y] == 14) {
              tile = document.getElementById("tree4");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // water1
          if (this.deska[x][y] == 31) {
              tile = document.getElementById("water1");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // water2
          if (this.deska[x][y] == 32) {
              tile = document.getElementById("water2");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // water3
          if (this.deska[x][y] == 33) {
              tile = document.getElementById("water3");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // water4
          if (this.deska[x][y] == 34) {
              tile = document.getElementById("water4");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // water5
          if (this.deska[x][y] == 35) {
              tile = document.getElementById("water5");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // water6
          if (this.deska[x][y] == 36) {
              tile = document.getElementById("water6");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // water7
          if (this.deska[x][y] == 37) {
              tile = document.getElementById("water7");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // dog house
          if (this.deska[x][y] == 41) {
              tile = document.getElementById("doghouse");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // barn
          if (this.deska[x][y] == 42) {
              tile = document.getElementById("barn");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // carrot
          if (this.deska[x][y] == 43) {
              tile = document.getElementById("carrot");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // fence1
          if (this.deska[x][y] == 51) {
              tile = document.getElementById("fence1");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // fence2
          if (this.deska[x][y] == 52) {
              tile = document.getElementById("fence2");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }

          // fence3
          if (this.deska[x][y] == 53) {
              tile = document.getElementById("fence3");
              var dif_y = tile1.height - tile.height;
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x, x*move_y/2 + y*move_y/2+zarovnani_y+ dif_y*scale, tile.width*scale, tile.height*scale);
          }


          // slepice
          if (this.deska[x][y] == 301) {
              tile = document.getElementById("chicken1");
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x+35*scale, x*move_y/2 + y*move_y/2+zarovnani_y-12*scale, tile.width*scale, tile.height*scale);
          }

          // slepice
          if (this.deska[x][y] == 302) {
              tile = document.getElementById("chicken2");
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x+35*scale, x*move_y/2 + y*move_y/2+zarovnani_y-12*scale, tile.width*scale, tile.height*scale);
          }

          // pes
          if (this.deska[x][y] == 401) {
              tile = document.getElementById("dog1");
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x+15*scale, x*move_y/2 + y*move_y/2+zarovnani_y-48*scale, tile.width*scale*0.9, tile.height*scale*0.9);
          }

          if (this.deska[x][y] == 402) {
              tile = document.getElementById("dog2");
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x+5*scale, x*move_y/2 + y*move_y/2+zarovnani_y-48*scale, tile.width*scale*0.9, tile.height*scale*0.9);
          }

          if (this.deska[x][y] == 403) {
              tile = document.getElementById("dog3");
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x-1*scale, x*move_y/2 + y*move_y/2+zarovnani_y-63*scale, tile.width*scale*0.9, tile.height*scale*0.9);
          }

          if (this.deska[x][y] == 404) {
              tile = document.getElementById("dog4");
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x+20*scale, x*move_y/2 + y*move_y/2+zarovnani_y-63*scale, tile.width*scale*0.9, tile.height*scale*0.9);
          }



          // TODO: zjednodusit
          // lišák Alan
          if (this.deska[x][y] == 201 || this.deska[x][y] == 211 || this.deska[x][y] == 221 || this.deska[x][y] == 231) {
              tile = document.getElementById("fox1");
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x+10*scale, x*move_y/2 + y*move_y/2+zarovnani_y-55*scale, tile.width*scale, tile.height*scale);
          }

          if (this.deska[x][y] == 202 || this.deska[x][y] == 212 || this.deska[x][y] == 222 || this.deska[x][y] == 232) {
              tile = document.getElementById("fox2");
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x+10*scale, x*move_y/2 + y*move_y/2+zarovnani_y-55*scale, tile.width*scale, tile.height*scale);
          }

          if (this.deska[x][y] == 203|| this.deska[x][y] == 213 || this.deska[x][y] == 223 || this.deska[x][y] == 233) {
              tile = document.getElementById("fox3");
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x+10*scale, x*move_y/2 + y*move_y/2+zarovnani_y-55*scale, tile.width*scale, tile.height*scale);
          }

          if (this.deska[x][y] == 204|| this.deska[x][y] == 214 || this.deska[x][y] == 224 || this.deska[x][y] == 234) {
              tile = document.getElementById("fox4");
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x+10*scale, x*move_y/2 + y*move_y/2+zarovnani_y-55*scale, tile.width*scale, tile.height*scale);
          }

          if (this.deska[x][y] == 501|| (this.deska[x][y] > 210 && this.deska[x][y] < 215 )) {
              tile = document.getElementById("flower1");
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x + 2*tile.width*scale, x*move_y/2 + y*move_y/2+zarovnani_y + tile.width*scale/2, tile.width*scale, tile.height*scale);
          }

          if (this.deska[x][y] == 502|| (this.deska[x][y] > 220 && this.deska[x][y] < 225 )) {
              tile = document.getElementById("flower2");
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x + 2*tile.width*scale, x*move_y/2 + y*move_y/2+zarovnani_y + tile.width*scale/2, tile.width*scale, tile.height*scale);
          }

          if (this.deska[x][y] == 503|| (this.deska[x][y] > 230 && this.deska[x][y] < 235 )) {
              tile = document.getElementById("flower3");
              context.drawImage(tile, x*(-move_x/2) + y*move_x/2 + zarovnani_x + 2*tile.width*scale, x*move_y/2 + y*move_y/2+zarovnani_y + tile.width*scale/2, tile.width*scale, tile.height*scale);
          }

        }
      }
    },

    hlaseni: function(postava,smer,x, y, hlaseni) {
      var elem = document.getElementById('deska');
      var context = elem.getContext('2d');
     // alert([x,y,smer]);
      var scale = 0.8;

      var okraj = 5;
      var font = 12;
      context.font =  font +"pt arial";
      var text_width = context.measureText(hlaseni).width;
      var text_height= context.measureText(hlaseni).height;
      context.fillStyle = "#fff";
      context.strokeStyle = "#aaa"
      context.lineWidth = 1;


      tile1 = document.getElementById("grass1");
      // 1 liska, 2 pes, 3 slepice
      switch(postava) {
          case 1:
            posun_x = 0;
            posun_y = 0;
            switch(smer) {
              case 1:
                tile = document.getElementById("fox1");
                posun_x = (1.3*tile.width)*scale;
                posun_y = (tile.height/1.8)*scale;
                break;
              case 2:
                posun_x = (tile.width/18)*scale-text_width;
                posun_y = (tile.height/1.8)*scale;
                tile = document.getElementById("fox2");
                break;
              case 3:
                tile = document.getElementById("fox3");
                posun_x = (tile.width/16)*scale-text_width;
                posun_y = (tile.height/4)*scale;
                break;
              case 4:
                tile = document.getElementById("fox4");
                posun_x = (1.3*tile.width)*scale;
                posun_y = (tile.height/4)*scale;
                break;
              default:
                tile = document.getElementById("fox1");
            }
            break;
          case 2:
            posun_x = 0;
            posun_y = 0;
            switch(smer) {
              case 1:
                tile = document.getElementById("dog1");
                posun_x = (1.2*tile.width)*scale;
                posun_y = (tile.height/1.8)*scale;
                break;
              case 2:
                tile = document.getElementById("dog2");
                posun_x = 0-text_width;
                posun_y = (tile.height/1.8)*scale;
                break;
              case 3:
                tile = document.getElementById("dog3");
                posun_x = (-tile.width/16)*scale-text_width;
                posun_y = (tile.height/6)*scale;
                break;
              case 4:
                tile = document.getElementById("dog4");
                posun_x = (1.25*tile.width)*scale;
                posun_y = (tile.height/6)*scale;
                break;
              default:
                tile = document.getElementById("dog1");
            }
            break;
          case 3:
            switch(smer) {
              case 1:
                tile = document.getElementById("chicken1");
                posun_x = (2*tile.width)*scale;
                posun_y = (tile.height/1.8)*scale;
                break;
              case 2:
                tile = document.getElementById("chicken2");
                posun_x = (tile.width/2)*scale-text_width;
                posun_y = (tile.height/1.8)*scale;
                break;
            }
            break;
          default:
            tile = document.getElementById("grass1");
      }
      var move_x = tile1.width*scale;
      var move_y = tile1.height*scale - 5*scale;
      var zarovnani_x = 450 + posun_x;
      var zarovnani_y = 60 + posun_y;
      var odsazeni_x = -5*scale;


      context.fillRect(x*(-move_x/2) + y*move_x/2 + zarovnani_x-okraj+odsazeni_x, x*move_y/2 + y*move_y/2+zarovnani_y - 3*tile.width*scale/4-font/2-okraj, text_width+2*okraj, font+2*okraj*scale);
      context.strokeRect(x*(-move_x/2) + y*move_x/2 + zarovnani_x-okraj+odsazeni_x, x*move_y/2 + y*move_y/2+zarovnani_y - 3*tile.width*scale/4-font/2-okraj, text_width+2*okraj, font+2*okraj*scale);
      context.fillStyle = "black";
      context.textAlign = "center";
      context.textBaseline = 'middle';
      context.fillText(hlaseni, x*(-move_x/2) + y*move_x/2 + zarovnani_x+text_width/2 + odsazeni_x, x*move_y/2 + y*move_y/2+zarovnani_y - 3*tile.width*scale/4);
    },

    // vykonavani herni smycky
    proved: function(instrukce) {

      // implementuje zasobnikove vyhodnocovani
      this.prikazy = instrukce.split(/ |\n/).filter(Boolean);
      this.zasobnik = [];
      this.funkce = [];

      this.funkce[0] = this.prikazy.findIndex(function(ins) {return ins=="PROGRAM";});
      this.funkce[1] = this.prikazy.findIndex(function(ins) {return ins=="F1";});
      this.funkce[2] = this.prikazy.findIndex(function(ins) {return ins=="F2";});

      this.instrukce = this.funkce[0];

      //alert(this.prikazy);
      window.requestAnimationFrame(smycka);
    },
  }




// beh hlavniho programu
// TODO: zaclenit do objektu hra
function smycka() {
    try {
        if(hra.instrukce>=hra.prikazy.length) return;

        if(hra.prikazy[hra.instrukce]=='PROGRAM') {
          hra.zasobnik.push(['PROGRAM']);
          hra.instrukce += 1;
        }

        if(hra.prikazy[hra.instrukce]=='F1()') {
          hra.zasobnik.push(['FUNKCE', hra.instrukce+1]); // skok zpět na nasledujici instrukci
          hra.instrukce == hra.funkce[1] + 1; // nasledujici instrukce ve funkci f1
        }

        if(hra.prikazy[hra.instrukce]=='OPAKUJ') {
          hra.zasobnik.push(['OPAKUJ', hra.instrukce+2, hra.prikazy[hra.instrukce+1]]); // skok a cislo
          hra.instrukce += 2; // nasledujici instrukce
        }

        if(hra.prikazy[hra.instrukce]=='WHILE') {
          hra.zasobnik.push(['WHILE', hra.instrukce+2, hra.prikazy[hra.instrukce+1]]); // skok a typ podminky
          hra.instrukce += 2; // nasledujici instrukce
        }

        if(hra.prikazy[hra.instrukce]=='IF') {
          if (hra.prikazy[hra.instrukce+1]=='P1') {
            if(!hra.podminka_P1()) {
              hra.instrukce += 2;
            }
            else {
              let counter = 1;
              for(let i = hra.instrukce+2; i <= hra.prikazy.length; i++) {
                if(hra.prikazy[i]=='WHILE' || hra.prikazy[i]=='IF' || hra.prikazy[i]=='OPAKUJ') {
                  counter += 1;
                }
                if(hra.prikazy[i]=='END') {
                  counter -= 1;
                }
                if(counter == 0) {
                  hra.instrukce = i+1;
                  break;
                }
              }
            }
          }
        }

        if(hra.prikazy[hra.instrukce]=='IF') {
          if (hra.prikazy[hra.instrukce+1]=='P2') {
            if(!hra.podminka_P2()) {
              hra.instrukce += 2;
            }
            else {
              let counter = 1;
              for(let i = hra.instrukce+2; i <= hra.prikazy.length; i++) {
                if(hra.prikazy[i]=='WHILE' || hra.prikazy[i]=='IF' || hra.prikazy[i]=='OPAKUJ') {
                  counter += 1;
                }
                if(hra.prikazy[i]=='END') {
                  counter -= 1;
                }
                if(counter == 0) {
                  hra.instrukce = i+1;
                  break;
                }
              }
            }
          }
        }

        if(hra.prikazy[hra.instrukce]=='IF') {
          if (hra.prikazy[hra.instrukce+1]=='P3') {
            if(!hra.podminka_P3()) {
              hra.instrukce += 2;
            }
            else {
              let counter = 1;
              for(let i = hra.instrukce+2; i <= hra.prikazy.length; i++) {
                if(hra.prikazy[i]=='WHILE' || hra.prikazy[i]=='IF' || hra.prikazy[i]=='OPAKUJ') {
                  counter += 1;
                }
                if(hra.prikazy[i]=='END') {
                  counter -= 1;
                }
                if(counter == 0) {
                  hra.instrukce = i+1;
                  break;
                }
              }
            }
          }
        }

        if(hra.prikazy[hra.instrukce]=='END') {
          vrchol = hra.zasobnik.pop();

          if (vrchol[0]=='PROGRAM') {
            return;
          }

          if (vrchol[0]=='FUNKCE') {
            hra.instrukce = vrchol[1];
          }

          if (vrchol[0]=='OPAKUJ') {
            if(vrchol[2] > 1) {
              vrchol[2] -= 1;
              hra.instrukce = vrchol[1];
              hra.zasobnik.push(vrchol);
            }
          }

          if (vrchol[0]=='WHILE') {
            if(vrchol[2]=='P1') {
              if(hra.podminka_P1()) {
                hra.instrukce = vrchol[1];
                hra.zasobnik.push(vrchol);
              }
            }
          }

          if (vrchol[0]=='WHILE') {
            if(vrchol[2]=='P2') {
              if(hra.podminka_P2()) {
                hra.instrukce = vrchol[1];
                hra.zasobnik.push(vrchol);
              }
            }
          }

          if (vrchol[0]=='WHILE') {
            if(vrchol[2]=='P3') {
              if(hra.podminka_P3()) {
                hra.instrukce = vrchol[1];
                hra.zasobnik.push(vrchol);
              }
            }
          }
        }

        if(hra.prikazy[hra.instrukce]=='KROK') {
          hra.krok();
          hra.nakresli_mapu();
        }

        if(hra.prikazy[hra.instrukce]=='SEBER_SLEPICI') {
          hra.seber_slepici();
          hra.nakresli_mapu();
        }

        if(hra.prikazy[hra.instrukce]=='OTOC_VLEVO') {
          hra.otoc_vlevo();
          hra.nakresli_mapu();
        }

        if(hra.prikazy[hra.instrukce]=='OTOC_VPRAVO') {
          hra.otoc_vpravo();
          hra.nakresli_mapu();
        }
    }
    catch (e) {
      if(e=="lisak pres palubu") {
        var [x,y] = hra.najdi_alana();
        var smer = hra.smer_alana();
        hra.hlaseni(1, smer, x, y, "Tam nechci.");
        return;
      }

      else if(e=="zakazane") {
        var [x,y] = hra.najdi_alana();
        var smer = hra.smer_alana();
        hra.hlaseni(1, smer, x, y, "Tam nemůžu.");
        return;
      }

      else if(e=="konec") {
        var [x,y] = hra.najdi_alana();
        var smer = hra.smer_alana();
        hra.hlaseni(1, smer, x, y, "A mám je všechny!")
        //hra.instrukce=hra.prikazy.length+1;
        return;
      }

      else {
        alert(e);
      }
    }

    hra.instrukce += 1;

    //console.log(hra.stop);
    if (!hra.stop) {
      setTimeout(function(){window.requestAnimationFrame(smycka)}, 160);
    }
  }


// výchozí level
var level = 1;

if(window.location.hash) {
  level = parseInt(window.location.hash.slice(1));
  if(isNaN(level)) level = 1;
}




// inicializace hry
hra.init();


// funkce pro generování kódu
function myUpdateFunction(event) {
  var code = Blockly.JavaScript.workspaceToCode(hra.workspace);
  document.getElementById('textarea').value = code;
}

hra.workspace.addChangeListener(myUpdateFunction);

hra.nacti_level(level);
hra.nakresli_mapu();

// hlasení
hra.hlaseni(3,1,2,1, "kvokkvokkvokkvokkvok");
hra.hlaseni(3,2,2,5, "kvokkvokkvokkvokkvok");

// Fox on run :-)
// hlavní ovládání aplikace (napojeno na API)
function run() {
  document.getElementById('start').style.display = "none";
  document.getElementById('stop').style.display = "block";
  hra.stop = 0;
  setTimeout(function(){hra.proved(Blockly.JavaScript.workspaceToCode(hra.workspace))}, 100);
}

function reset() {
  hra.stop = 0;
  hra.reset();
}

function stop() {
  hra.reset();
  hra.stop = 1;
  document.getElementById('start').style.display = "block";
  document.getElementById('stop').style.display = "none";
}
</script>

</body>
</html>
